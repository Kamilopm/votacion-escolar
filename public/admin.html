<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de AdministraciÃ³n - VotaciÃ³n Escolar</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background:#f1f5f9; margin:0 }
.container { max-width:1400px; margin:auto; padding:20px }
.hidden { display:none }
button { padding:8px 14px; margin:5px; cursor:pointer }
table { width:100%; border-collapse:collapse; margin-top:10px }
th,td { border:1px solid #ccc; padding:6px; text-align:left }
th { background:#e5e7eb }
.card { background:white; padding:15px; border-radius:8px; margin-bottom:20px }
.danger { background:#ef4444; color:white }
.warning { background:#f59e0b; color:white }
.success { background:#10b981; color:white }
header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap }
.carnet { border:1px solid #000; padding:10px; width:260px; margin:10px; display:inline-block }
</style>
</head>

<body>
<div class="container">

<!-- LOGIN -->
<div id="loginBox" class="card">
<h2>ğŸ” Acceso Administrativo</h2>
<input id="adminCode" type="password" placeholder="Clave administrador">
<br><br>
<button onclick="login()">Ingresar</button>
<p id="loginError" style="color:red"></p>
</div>

<!-- PANEL -->
<div id="panel" class="hidden">

<header class="card">
<div>
<h1>âš™ï¸ Panel de AdministraciÃ³n</h1>
<p id="estadoVotacion">Estado: â€”</p>
</div>
<div>
<button onclick="toggleElection()" class="warning">Abrir / Cerrar votaciÃ³n</button>
<button onclick="resetearVotacion()" class="danger">â™»ï¸ REINICIAR VOTACIÃ“N</button>
</div>
</header>

<div class="card">
<h2>ğŸ‘©â€ğŸ“ Estudiantes</h2>
<button onclick="cargarEstudiantes()">ğŸ”„ Actualizar</button>
<button onclick="eliminarTodo()" class="danger">ğŸ—‘ï¸ ELIMINAR TODO</button>
<button onclick="imprimirCarnets()" class="success">ğŸ–¨ï¸ IMPRIMIR CARNETS</button>
<div id="tablaEstudiantes"></div>
</div>

<div class="card">
<h2>ğŸ“¥ Importar Estudiantes (Excel)</h2>
<input type="file" id="excelFile" accept=".xlsx,.xls">
<button onclick="importarExcel()">Importar</button>
<div id="importMsg"></div>
</div>

</div>
</div>

<script>
const API = "/api";
let ADMIN = "";
let estudiantes = [];

function login(){
  ADMIN = document.getElementById("adminCode").value.trim();
  fetch(API+"/admin/login",{
    method:"POST",
    headers:{"x-admin-code":ADMIN}
  })
  .then(r=>r.ok?r.json():Promise.reject())
  .then(()=>{
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("panel").classList.remove("hidden");
    cargarEstado();
    cargarEstudiantes();
  })
  .catch(()=>document.getElementById("loginError").innerText="CÃ³digo incorrecto");
}

function cargarEstado(){
 fetch(API+"/check-status")
 .then(r=>r.json())
 .then(d=>{
  document.getElementById("estadoVotacion").innerText =
   "Estado: "+(d.open?"ABIERTA":"CERRADA");
 });
}

function toggleElection(){
 fetch(API+"/admin/election",{
  method:"POST",
  headers:{
    "Content-Type":"application/json",
    "x-admin-code":ADMIN
  },
  body:JSON.stringify({ action:"open" })
 }).then(()=>cargarEstado());
}

/* ğŸ” REINICIAR VOTACIÃ“N COMPLETA */
function resetearVotacion(){
 if(!confirm("âš ï¸ Esto borrarÃ¡ TODOS los votos y permitirÃ¡ votar nuevamente.\nÂ¿Confirmas?")) return;
 fetch(API+"/admin/clear-data",{
  method:"POST",
  headers:{
    "Content-Type":"application/json",
    "x-admin-code":ADMIN
  },
  body:JSON.stringify({ confirm:"ELIMINAR TODO" })
 }).then(()=>{
  alert("VotaciÃ³n reiniciada correctamente");
  cargarEstado();
  cargarEstudiantes();
 });
}

/* ğŸ‘©â€ğŸ“ CARGAR ESTUDIANTES */
function cargarEstudiantes(){
 fetch(API+"/admin/students",{ headers:{ "x-admin-code":ADMIN }})
 .then(r=>r.json())
 .then(d=>{
  estudiantes = d.students || [];
  let html="<table><tr><th>CÃ³digo</th><th>Nombre</th><th>Grado</th><th>Curso</th><th>Estado</th></tr>";
  estudiantes.forEach(s=>{
    html+=`<tr>
      <td>${s.access_code}</td>
      <td>${s.full_name}</td>
      <td>${s.grade}</td>
      <td>${s.course}</td>
      <td>${s.has_voted ? "VotÃ³" : "Pendiente"}</td>
    </tr>`;
  });
  html+="</table>";
  document.getElementById("tablaEstudiantes").innerHTML=html;
 });
}

/* ğŸ—‘ï¸ ELIMINAR TODO (ARREGLADO) */
function eliminarTodo(){
 if(!confirm("âš ï¸ ELIMINAR TODOS LOS ESTUDIANTES.\nEsta acciÃ³n NO se puede deshacer.\nÂ¿Continuar?")) return;
 fetch(API+"/admin/clear-data",{
  method:"POST",
  headers:{
    "Content-Type":"application/json",
    "x-admin-code":ADMIN
  },
  body:JSON.stringify({ confirm:"ELIMINAR TODO" })
 }).then(()=>{
  alert("Todos los estudiantes eliminados");
  cargarEstudiantes();
 });
}

/* ğŸ–¨ï¸ IMPRIMIR CARNETS */
function imprimirCarnets(){
 if(estudiantes.length===0){ alert("No hay estudiantes"); return; }
 const w=window.open("");
 w.document.write("<h1>Carnets Electorales</h1>");
 estudiantes.forEach(s=>{
  w.document.write(`
    <div class="carnet">
      <strong>${s.full_name}</strong><br>
      Grado: ${s.grade}<br>
      Curso: ${s.course}<br>
      CÃ³digo: <strong>${s.access_code}</strong>
    </div>
  `);
 });
 w.print();
}

/* ğŸ“¥ IMPORTAR EXCEL */
function importarExcel(){
 const file=document.getElementById("excelFile").files[0];
 if(!file){ alert("Selecciona archivo Excel"); return; }
 const reader=new FileReader();
 reader.onload=e=>{
  const wb=XLSX.read(e.target.result,{type:"binary"});
  const data=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
  fetch(API+"/admin/import",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "x-admin-code":ADMIN
    },
    body:JSON.stringify({ students:data })
  }).then(()=>{ alert("ImportaciÃ³n completa"); cargarEstudiantes(); });
 };
 reader.readAsBinaryString(file);
}
</script>

</body>
</html>
